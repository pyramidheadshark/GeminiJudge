# geminijudge/prompts.py

MODEL_A_ANSWER_ID = "ОТВЕТ_МОДЕЛИ_A"
INCORRECT_ANSWER_PARSING_PREFIX = "НЕПРАВИЛЬНЫЙ_ОТВЕТ:"
EVALUATION_SECTION_DELIMITER = "--- РАЗДЕЛ ОБОСНОВАНИЯ ---" # Разделитель для парсинга ID и обоснования


def get_incorrect_answer_id(index: int) -> str:
    return f"НЕПРАВИЛЬНЫЙ_ОТВЕТ_{index + 1}"

def get_generate_incorrect_answers_prompt(user_prompt: str, model_a_response: str, num_incorrect_samples: int) -> str:
    return f"""
Тебе предоставлены:
1. Контекстные документы (прикреплены к этому запросу). Тщательно изучи их содержимое.
2. Оригинальный промпт пользователя, на который нужно было ответить.
3. Ответ "Модели А" на этот промпт (считай его условно корректным ориентиром).

Твоя задача: Сгенерировать ровно {num_incorrect_samples} (штук) заведомо НЕПРАВИЛЬНЫХ, но внешне правдоподобных и релевантных промпту ответов.
Каждый "неправильный" ответ должен:
- **Искажать факты из документов:** Содержать утверждения, которые прямо противоречат информации в прикрепленных файлах, или неверно интерпретировать ключевые данные, числа, даты, имена или события, описанные в документах.
- **Упускать критическую информацию:** Игнорировать важные детали или контекст из документов, которые необходимы для полного и точного ответа на оригинальный промпт пользователя, делая ответ неполным или вводящим в заблуждение.
- **Вводить "ложные следы":** Упоминать концепции или факты, которые могут показаться связанными с темой промпта и содержимым документов, но на самом деле либо отсутствуют в документах, либо представлены в них совершенно иначе.
- **Быть релевантным промпту:** Несмотря на неверность, ответ должен выглядеть так, будто он пытается ответить на оригинальный промпт пользователя.
- **Отличаться от ответа "Модели А" и друг от друга:** Каждый неправильный ответ должен предлагать уникальный способ ошибиться.
- **Быть на русском языке.**

Оригинальный промпт пользователя:
---
{user_prompt}
---
Ответ "Модели А":
---
{model_a_response}
---

Сгенерируй {num_incorrect_samples} НЕПРАВИЛЬНЫХ ответов. Каждый ответ должен начинаться с новой строки и префикса "{INCORRECT_ANSWER_PARSING_PREFIX}".
Пример:
{INCORRECT_ANSWER_PARSING_PREFIX} [Текст первого неправильного ответа, искажающий факт из документа X]
{INCORRECT_ANSWER_PARSING_PREFIX} [Текст второго неправильного ответа, упускающий важную деталь из документа Y]

Не добавляй никаких других пояснений. Только ответы с указанным префиксом.
Твоя цель — создать сложные для проверки "ловушки", а не очевидные ошибки.
"""

def get_evaluate_responses_prompt(user_prompt: str, all_responses_text_block: str) -> str:
    return f"""
Ты — высококвалифицированный эксперт-аналитик, специализирующийся на глубокой проверке фактов и оценке качества информации ИСКЛЮЧИТЕЛЬНО на основе предоставленных документов.
Тебе даны:
1.  **Контекстные документы:** (прикреплены к этому запросу). Это ЕДИНСТВЕННЫЙ источник правды. Любая информация вне этих документов должна игнорироваться.
2.  **Оригинальный промпт пользователя:** Запрос, на который требовался ответ.
3.  **Набор ответов-кандидатов:** Несколько вариантов ответов на промпт, каждый с уникальным идентификатором.

ТВОЯ ЗАДАЧА:
Провести детальный анализ каждого ответа-кандидата в соответствии со следующими шагами и критериями:

**Шаг 1: Глубокий анализ и поиск подтверждений в документах.**
Для КАЖДОГО ответа-кандидата:
    а. **Поиск фактов:** Тщательно проверь КАЖДОЕ утверждение, факт, число, дату, имя или концепцию в ответе. Найди точные места в прикрепленных документах, которые подтверждают или опровергают эти утверждения. Обращай внимание не только на явную информацию, но и на второстепенные детали и скрытые связи.
    б. **Оценка полноты:** Определи, насколько полно ответ охватывает аспекты промпта, которые МОГУТ БЫТЬ освещены на основе ТОЛЬКО прикрепленных документов. Учитывай, не упущены ли важные детали, которые присутствуют в документах и релевантны промпту.
    в. **Оценка точности интерпретации:** Проверь, не искажает ли ответ смысл информации из документов, не делает ли неверных выводов или обобщений.

**Шаг 2: Выбор наилучшего ответа.**
На основе анализа из Шага 1, выбери ОДИН ответ-кандидат, который является НАИБОЛЕЕ точным, полным, и релевантным ОРИГИНАЛЬНОМУ ПРОМПТУ, и при этом ПОЛНОСТЬЮ подкреплен информацией из ПРИКРЕПЛЕННЫХ ДОКУМЕНТОВ.

**Шаг 3: Обоснование выбора.**
Предоставь детальное обоснование твоего выбора. Обоснование ДОЛЖНО включать:
    а. **Почему выбранный ответ лучший:** Укажи конкретные сильные стороны выбранного ответа со ссылками на информацию из документов (например, "Утверждение Х в выбранном ответе подтверждается абзацем Y в документе Z"). Объясни, как он точно и полно отвечает на промпт, опираясь на документы.
    б. **Почему другие ответы хуже (кратко):** Для 1-2 основных отвергнутых кандидатов (особенно для "ОТВЕТА_МОДЕЛИ_А", если он не выбран) кратко укажи ключевые недостатки (например, "Ответ_Б содержит неточность по поводу даты Х, которая в документе Y указана как Z" или "Ответ_В упускает важный аспект Q, описанный в документе W").

Оригинальный промпт пользователя:
---
{user_prompt}
---
Варианты ответов для оценки:
---
{all_responses_text_block}
---

ФОРМАТ ТВОЕГО ОТВЕТА:
Твой ответ должен состоять из двух частей, разделенных специальным маркером.

1.  **Идентификатор выбранного ответа:** На первой строке ТОЛЬКО идентификатор лучшего ответа (например, "{MODEL_A_ANSWER_ID}" или "{get_incorrect_answer_id(0)}").
2.  **Обоснование:** После идентификатора, на новой строке, вставь маркер "{EVALUATION_SECTION_DELIMITER}". Затем, на следующих строках, предоставь детальное обоснование твоего выбора, как описано в Шаге 3.

Пример формата ответа:
{MODEL_A_ANSWER_ID}
{EVALUATION_SECTION_DELIMITER}
Выбранный ответ ({MODEL_A_ANSWER_ID}) является наилучшим, потому что он точно цитирует статистику из документа "Отчет_2023.pdf" (страница 5, параграф 2) касательно роста производства. Также он полно раскрывает причины этого роста, упомянутые в документе "Анализ_рынка.docx" (раздел 3.1).
{get_incorrect_answer_id(0)} хуже, так как он неверно указывает дату ключевого события (в документе "История_проекта.txt" это 2022 год, а не 2021).
... (и так далее)

Будь предельно внимателен и объективен. Твой анализ должен быть безупречен с точки зрения фактов из документов.
Если ни один ответ не является идеальным, выбери тот, который содержит наименьшее количество существенных ошибок и наиболее полно отвечает на запрос в рамках документов.
"""